## 1. XmlBeanFactory注册bean流程

### 初始化XmlBeanFactory

```java
public XmlBeanFactory(Resource resource) throws BeansException {
	this(resource, null);
}
```

间接调用构造器

```java
public XmlBeanFactory(Resource resource, BeanFactory parentBeanFactory) throws BeansException {
	super(parentBeanFactory);
	this.reader.loadBeanDefinitions(resource);
}
```
#### 1. super(parentBeanFactory)
##### 1. 间接调用AbstractAutowireCapableBeanFactory的构造器

```
public AbstractAutowireCapableBeanFactory() {
	super();
	ignoreDependencyInterface(BeanNameAware.class);
	ignoreDependencyInterface(BeanFactoryAware.class);
	ignoreDependencyInterface(BeanClassLoaderAware.class);
}
```
- **ignoreDependencyInterface方法**

  > 传入class参数，取消给定接口的自动装配

#### 2. this.reader.loadBeanDefinitions(resource)

> reader :
>
> private final XmlBeanDefinitionReader reader = new XmlBeanDefinitionReader(this);

#### 2.1 调用XmlBeanDefinitionReader

```
public int loadBeanDefinitions(Resource resource) throws BeanDefinitionStoreException {
	return loadBeanDefinitions(new EncodedResource(resource));
}
```

##### 2.1.1 new EncodedResource(resource)

> 将resource封装为**EncodedResource**,

##### 2.1.2 执行loadBeanDefinitions()方法

```
public int loadBeanDefinitions(EncodedResource encodedResource) throws BeanDefinitionStoreException {
	Assert.notNull(encodedResource, "EncodedResource must not be null");
	if (logger.isTraceEnabled()) {
		logger.trace("Loading XML bean definitions from " + encodedResource);
	}

	Set<EncodedResource> currentResources = this.resourcesCurrentlyBeingLoaded.get();
	if (currentResources == null) {
		currentResources = new HashSet<>(4);
		this.resourcesCurrentlyBeingLoaded.set(currentResources);
	}
	if (!currentResources.add(encodedResource)) {
		throw new BeanDefinitionStoreException(
				"Detected cyclic loading of " + encodedResource + " - check your import definitions!");
	}
	try {
		// 通过encodeResource获取InputStream
		InputStream inputStream = encodedResource.getResource().getInputStream();
		try {
			InputSource inputSource = new InputSource(inputStream);
			if (encodedResource.getEncoding() != null) {
				inputSource.setEncoding(encodedResource.getEncoding());
			}
			// 实际上的加载beans方法
			return doLoadBeanDefinitions(inputSource, encodedResource.getResource());
		}
		finally {
			inputStream.close();
		}
	}
	catch (IOException ex) {
		throw new BeanDefinitionStoreException(
				"IOException parsing XML document from " + encodedResource.getResource(), ex);
	}
	finally {
		currentResources.remove(encodedResource);
		if (currentResources.isEmpty()) {
			this.resourcesCurrentlyBeingLoaded.remove();
		}
	}
}
```

**doLoadBeanDefinitions()方法**

```
protected int doLoadBeanDefinitions(InputSource inputSource, Resource resource){
	// 加载资源文件
	Document doc = doLoadDocument(inputSource, resource);
	// 注册bean
	int count = registerBeanDefinitions(doc, resource);
	if (logger.isDebugEnabled()) {
		logger.debug("Loaded " + count + " bean definitions from " + resource);
	}
	return count;
}
```

```
protected Document doLoadDocument(InputSource inputSource, Resource resource) throws Exception {
	// 获取xml资源文件的验证模式
	// 通过DocumentBuilderFactory创建DocumentBuilder，解析获取Document
	return this.documentLoader.loadDocument(inputSource, getEntityResolver(), this.errorHandler,
			getValidationModeForResource(resource), isNamespaceAware());
}
```

```
public int registerBeanDefinitions(Document doc, Resource resource) throws BeanDefinitionStoreException {
    // 创建reader
	BeanDefinitionDocumentReader documentReader = createBeanDefinitionDocumentReader();
	// 注册bean
	int countBefore = getRegistry().getBeanDefinitionCount();
	documentReader.registerBeanDefinitions(doc, createReaderContext(resource));
	return getRegistry().getBeanDefinitionCount() - countBefore;
}
```

















